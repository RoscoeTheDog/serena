# Plan: 5
# Generated by: discovery:5.d
# Timestamp: 2025-12-23T16:10:00Z

story_id: "5"
title: "Merge Tool and Resource Updates"
created: "2025-12-23T16:10:00Z"
created_by: "discovery:5.d"

# Analysis Summary
analysis:
  summary: "Integrate upstream tool changes including the replace_regex -> replace_content rename and other improvements. Fork has significant additions that must be preserved."
  complexity: "high"
  estimated_files: 9
  estimated_tokens: 15000
  risk_factors:
    - "Fork has 2,700+ lines of additions to tools - must preserve"
    - "Upstream renamed ReplaceRegexTool to ReplaceContentTool with enhanced functionality"
    - "Symbol tools have significant refactoring in upstream"
    - "JetBrains integration has upstream changes we may not need"

# Key Upstream Changes
upstream_changes:
  critical:
    - commit: "b6f88b9"
      description: "ReplaceRegexTool -> ReplaceContentTool with literal mode and new backreference syntax"
      files: ["file_tools.py", "memory_tools.py"]
      impact: "HIGH - tool rename we've already addressed in context files"

    - commit: "bb79bf9"
      description: "Refactored name path-based symbol retrieval - improved parameter names"
      files: ["symbol_tools.py"]
      impact: "MEDIUM - may affect our customizations"

    - commit: "2fe7dad"
      description: "GetSymbolOverviewTool now allows depth parameter"
      files: ["symbol_tools.py"]
      impact: "LOW - additive feature"

  minor:
    - commit: "f2c891c"
      description: "Allow non-ASCII in JSON responses"
      files: ["tools_base.py"]
      impact: "LOW - encoding improvement"

    - commit: "c1cb42b"
      description: "JetBrains refreshFile API"
      files: ["jetbrains_plugin_client.py", "jetbrains_tools.py"]
      impact: "LOW - JetBrains specific"

# Fork Customizations to Preserve
fork_customizations:
  config_tools.py:
    lines_added: 485
    features:
      - "Centralized storage management tools"
      - "Project configuration helpers"
      - "User config directory tools"
    preserve: "ALL"

  file_tools.py:
    lines_added: 356
    features:
      - "Enhanced file reading with encoding support"
      - "Additional file utilities"
    merge_strategy: "Cherry-pick upstream ReplaceContentTool changes, preserve fork additions"

  memory_tools.py:
    lines_added: 76
    features:
      - "Enhanced memory tool functionality"
    merge_strategy: "Cherry-pick upstream EditMemoryTool changes (replace_content syntax)"

  symbol_tools.py:
    lines_added: 921
    features:
      - "Advanced symbol manipulation tools"
      - "Symbol editing capabilities"
    merge_strategy: "Careful merge - preserve fork additions, adopt upstream refactoring"

  tools_base.py:
    lines_added: 433
    features:
      - "Enhanced base tool functionality"
      - "Additional tool markers"
    merge_strategy: "Cherry-pick encoding improvements, preserve fork additions"

  onboarding_helpers.py:
    lines_added: 468
    features:
      - "Full fork-specific onboarding system"
    preserve: "ALL - fork-only file"

# Implementation Strategy
implementation_strategy:
  approach: "Selective cherry-pick with conflict resolution"
  phases:
    - name: "Phase 1: ReplaceContentTool"
      files: ["file_tools.py"]
      description: "Adopt ReplaceContentTool rename and enhancements"

    - name: "Phase 2: Memory Tools"
      files: ["memory_tools.py"]
      description: "Update EditMemoryTool to use replace_content syntax"

    - name: "Phase 3: Symbol Tools"
      files: ["symbol_tools.py"]
      description: "Adopt depth parameter and refactoring, preserve fork additions"

    - name: "Phase 4: Base Tools"
      files: ["tools_base.py"]
      description: "Adopt encoding improvements"

    - name: "Phase 5: Skip JetBrains"
      files: ["jetbrains_*.py", "cmd_tools.py", "workflow_tools.py"]
      description: "Review but likely skip - JetBrains-specific changes"

# GATE Decision Required
gate_decisions:
  - id: "GATE-5.1"
    question: "ReplaceContentTool changes"
    context: |
      Upstream replaced ReplaceRegexTool with ReplaceContentTool:
      - New 'literal' mode for non-regex replacements
      - New backreference syntax: $!1, $!2 instead of \1, \2
      - More fail-safe for LLMs that struggle with escaping

      Since we already updated context files to use replace_content,
      we should adopt this tool change.
    recommendation: "ADOPT upstream ReplaceContentTool"

  - id: "GATE-5.2"
    question: "JetBrains tool changes"
    context: |
      Upstream has changes to JetBrains integration.
      Our fork may not use JetBrains integration heavily.
    recommendation: "SKIP - review in separate story if needed"

# Test Requirements
test_requirements:
  unit:
    - "ReplaceContentTool works with literal mode"
    - "ReplaceContentTool works with regex mode and $!N backreferences"
    - "EditMemoryTool works with replace_content syntax"
    - "Symbol tools depth parameter works"
    - "All fork tool additions still function"

  integration:
    - "Tool registration succeeds for all tools"
    - "No duplicate tool names"
    - "Context exclusions work correctly"

  security:
    - "No tools accidentally exposed"
    - "Encoding changes don't introduce vulnerabilities"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-5.1"
    text: "GATE: Scan tool changes for API/signature modifications"
    implementation: "Analysis complete - ReplaceContentTool has new API"
    gate_status: "NEEDS_HUMAN_APPROVAL"

  - id: "AC-5.2"
    text: "GATE: Check if any tools we've modified have upstream changes"
    implementation: "Conflicts identified in file_tools.py, symbol_tools.py, memory_tools.py"
    gate_status: "NEEDS_HUMAN_APPROVAL"

  - id: "AC-5.3"
    text: "Inventory new tools added upstream"
    implementation: "No new tools added - ReplaceContentTool is renamed, not new"
    status: "COMPLETE"

  - id: "AC-5.4"
    text: "Merge changes to src/serena/tools/"
    implementation: "Pending human approval of merge strategy"

  - id: "AC-5.5"
    text: "Tool exclusions work correctly"
    implementation: "Test after merge"

# Human Gate Summary
human_gate_summary: |
  Story 5 requires human approval for the following:

  1. **ReplaceContentTool Adoption** (GATE-5.1)
     - Upstream renamed ReplaceRegexTool to ReplaceContentTool
     - Added literal mode and new backreference syntax
     - RECOMMENDATION: Adopt (we already updated context files)

  2. **JetBrains Changes** (GATE-5.2)
     - Upstream has JetBrains-specific improvements
     - RECOMMENDATION: Skip for now

  3. **Merge Strategy**
     - Fork has 2,700+ lines of additions
     - Strategy: Preserve all fork additions, cherry-pick upstream improvements
     - RECOMMENDATION: Approve selective merge

# Notes
notes:
  - "Fork additions are substantial and must be preserved"
  - "ReplaceContentTool change aligns with Story 4 context updates"
  - "Consider JetBrains changes in future story if needed"
