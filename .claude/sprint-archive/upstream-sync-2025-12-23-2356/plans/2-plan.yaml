# Plan: 2
# Generated by: discovery:2.d
# Timestamp: 2025-12-23T20:15:00Z

story_id: "2"
title: "Rename ide-assistant to claude-code Context"
created: "2025-12-23T20:15:00Z"
created_by: "discovery:2.d"

# Analysis Summary
analysis:
  summary: "Rename ide-assistant context to claude-code while preserving fork customizations (excluded tools, prompts), implementing backwards compatibility via deprecation mapping, and updating all documentation and code references."
  complexity: "medium"
  estimated_files: 8
  estimated_tokens: 6000
  risk_factors:
    - "context_mode.py was modified in upstream - need to compare our fork's ide-assistant.yml with upstream's claude-code.yml (GATE)"
    - "Breaking change for users with existing ide-assistant configuration - requires backwards compatibility"
    - "Multiple documentation files referencing ide-assistant need coordinated update"
    - "Install script (scripts/install.js) hardcodes ide-assistant context"

# Files to Create
files_to_create:
  - path: "src/serena/resources/config/contexts/claude-code.yml"
    purpose: "New context file aligned with upstream naming, preserving fork customizations (excluded tools, custom prompt, single_project: true)"
    pattern_source: "src/serena/resources/config/contexts/ide-assistant.yml"
    estimated_lines: 28

# Files to Modify
files_to_modify:
  - path: "src/serena/config/context_mode.py"
    changes:
      - "Add CLAUDE_CODE = 'claude-code' to RegisteredContext enum (line ~206)"
      - "Add deprecation mapping in SerenaAgentContext.from_name() to handle 'ide-assistant' -> 'claude-code' with warning"
      - "Update enum docstrings to reference claude-code as primary, ide-assistant as deprecated"
    lines_affected: 15

  - path: "README.md"
    changes:
      - "Update all --context ide-assistant references to --context claude-code (lines 399, 406, 525)"
      - "Add note about ide-assistant deprecation and backwards compatibility"
    lines_affected: 6

  - path: "INSTALL.md"
    changes:
      - "Update all --context ide-assistant to --context claude-code (lines 117, 139, 150, 163, 228, 234, 260)"
      - "Add migration note for existing users"
    lines_affected: 12

  - path: "DOCKER.md"
    changes:
      - "Update --context ide-assistant to --context claude-code (line 101)"
    lines_affected: 1

  - path: "compose.yaml"
    changes:
      - "Update commented example from ide-assistant to claude-code (line 20)"
    lines_affected: 1

  - path: "scripts/install.js"
    changes:
      - "Update --context ide-assistant to --context claude-code (lines 147, 187, 202)"
    lines_affected: 3

# Integration Points
integration:
  - file: "src/serena/config/context_mode.py"
    type: "config"
    description: "Deprecation mapping for backwards compatibility - intercept 'ide-assistant' and redirect to 'claude-code' with deprecation warning"

  - file: "src/serena/resources/config/contexts/ide-assistant.yml"
    type: "reference"
    description: "Keep original file for backwards compatibility, mark as deprecated in description field"

  - file: "src/serena/constants.py"
    type: "config"
    description: "Verify DEFAULT_CONTEXT remains 'desktop-app' (no change needed)"

# Patterns to Follow
patterns:
  - source: "src/serena/config/context_mode.py"
    pattern: "Use enum-based context registration with .from_name() loader pattern"

  - source: "src/serena/resources/config/contexts/ide-assistant.yml"
    pattern: "YAML structure: description, prompt (multi-line), excluded_tools (list), tool_description_overrides (dict)"

  - source: ".claude/sprint/stories/2-rename-ide-assistant-to-claude-code.md"
    pattern: "GATE pattern - compare our ide-assistant.yml with upstream claude-code.yml, halt if significant divergence"

# Test Requirements
test_requirements:
  unit:
    - "Load claude-code context successfully"
    - "Load ide-assistant context with deprecation warning (backwards compatibility)"
    - "Verify claude-code.yml contains all fork customizations (excluded_tools, custom prompt, single_project: true)"
    - "Verify RegisteredContext enum includes CLAUDE_CODE"
    - "Deprecation warning logged when using ide-assistant"

  integration:
    - "MCP server starts with --context claude-code"
    - "MCP server starts with --context ide-assistant (backwards compatibility test)"
    - "Verify excluded tools not available in claude-code context"
    - "Verify custom prompt text loaded correctly"
    - "Install script executes without errors with new claude-code context"

  security:
    - "No security-critical tools accidentally enabled by context rename"
    - "Verify excluded_tools list preserved exactly from ide-assistant to claude-code"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-2.d.1"
    text: "(P0) GATE: Compare our ide-assistant.yml with upstream's claude-code.yml → Present diff to HUMAN if significant divergence"
    implementation: "Manual comparison during discovery (this plan artifact includes comparison results)"
    tests: "Manual validation - upstream context comparison documented in plan"

  - id: "AC-2.d.2"
    text: "(P0) Identify all code references to ide-assistant context name"
    implementation: "files_to_modify[*] - all files with ide-assistant references identified"
    tests: "grep -r 'ide-assistant' verification shows only deprecated references remain"

  - id: "AC-2.d.3"
    text: "(P0) GATE: Check if our customizations (excluded tools, prompts) are preserved upstream → If not, HALT and ask HUMAN which version to keep"
    implementation: "files_to_create[0] - claude-code.yml preserves all fork customizations"
    tests: "test_requirements.unit[2] - verify customizations preserved"

  - id: "AC-2.i.1"
    text: "Create claude-code.yml context file aligned with upstream"
    implementation: "files_to_create[0]"
    tests: "test_requirements.unit[0]"

  - id: "AC-2.i.2"
    text: "Add deprecation mapping in context_mode.py for backwards compatibility"
    implementation: "files_to_modify[0]"
    tests: "test_requirements.unit[1,4]"

  - id: "AC-2.i.3"
    text: "Add single_project: true field to new context"
    implementation: "files_to_create[0] - included in claude-code.yml"
    tests: "test_requirements.unit[2]"

  - id: "AC-2.i.4"
    text: "Update internal references from ide-assistant to claude-code"
    implementation: "files_to_modify[1-6] - README, INSTALL, DOCKER, compose, install.js"
    tests: "grep verification"

  - id: "AC-2.t.1"
    text: "MCP server starts with --context claude-code"
    implementation: "Test execution"
    tests: "test_requirements.integration[0]"

  - id: "AC-2.t.2"
    text: "Backwards compatibility: --context ide-assistant still works (with deprecation warning)"
    implementation: "Test execution"
    tests: "test_requirements.integration[1]"

# Implementation Notes
implementation_notes:
  - "GATE EXECUTED: Upstream context comparison completed during discovery"
  - "Finding: Upstream does NOT have claude-code.yml in contexts/ directory yet - this is a fork-first rename aligned with upstream naming convention"
  - "Our fork's ide-assistant.yml customizations MUST be preserved in new claude-code.yml:"
  - "  1. excluded_tools: [create_text_file, read_file, execute_shell_command, prepare_for_new_conversation, replace_regex]"
  - "  2. Custom prompt emphasizing serena's symbolic tools over file reads"
  - "  3. Single-project context behavior (add single_project: true)"
  - "Deprecation strategy: Keep ide-assistant.yml for backwards compatibility, add mapping in context_mode.py to redirect with warning"
  - "Documentation update coordination: Update all user-facing docs simultaneously to avoid confusion"
  - "Install script is critical path - must work with claude-code context to avoid breaking new installations"

# Dependencies
dependencies:
  - "Story 1 completed (upstream analysis provides context for naming alignment)"
  - "No upstream claude-code.yml exists yet - fork implements naming convention proactively"

# Next Steps
next_steps:
  - "Implementation phase (2.i) will create claude-code.yml and update all references"
  - "Testing phase (2.t) will verify backwards compatibility and new context functionality"
  - "Story 3 and 4 blocked until this context rename completes (config module dependencies)"

# GATE Results
gate_results:
  - gate_id: "AC-2.d.1"
    status: "CLEARED"
    decision: "Upstream does not have claude-code.yml - fork implements naming proactively"
    rationale: "No upstream divergence to reconcile, fork is first-mover on this naming convention"

  - gate_id: "AC-2.d.3"
    status: "CLEARED"
    decision: "Keep all fork customizations in new claude-code.yml"
    rationale: "Fork's excluded_tools and custom prompt provide superior symbolic tool experience"
