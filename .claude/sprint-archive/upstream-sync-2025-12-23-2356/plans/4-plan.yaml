# Plan: 4
# Generated by: discovery:4.d
# Timestamp: 2025-12-23T15:00:00Z

story_id: "4"
title: "Update Context YAML Files"
created: "2025-12-23T15:00:00Z"
created_by: "discovery:4.d"

# Analysis Summary
analysis:
  summary: "Sync context YAML files with upstream, adding new ide.yml and updating existing files with improved prompts and single_project field documentation. One file (ide-assistant.yml) needs archiving."
  complexity: "medium"
  estimated_files: 7
  estimated_tokens: 8000
  risk_factors:
    - "Fork has claude-code.yml with replace_regex tool excluded, upstream uses replace_content"
    - "Multiple files have prompt wording changes that need careful review"
    - "ide-assistant.yml exists in fork but deleted in upstream (needs archiving)"
    - "Need to ensure RegisteredContext enum doesn't need IDE entry (upstream doesn't have it)"

# Files to Create
files_to_create:
  - path: "src/serena/resources/config/contexts/ide.yml"
    purpose: "New generic IDE coding agent context with single_project support"
    pattern_source: "upstream:src/serena/resources/config/contexts/ide.yml"
    estimated_lines: 30
    notes: "Direct copy from upstream - no fork-specific customizations needed"

# Files to Modify
files_to_modify:
  - path: "src/serena/resources/config/contexts/claude-code.yml"
    changes:
      - "Update description from 'Non-symbolic editing tools...' to 'Claude Code (CLI agent...)'"
      - "Simplify prompt text to match upstream (remove verbose explanations)"
      - "Change excluded tool from 'replace_regex' to 'replace_content'"
      - "Add single_project field documentation comment"
    lines_affected: 28
    fork_customizations: "Currently excludes replace_regex, upstream excludes replace_content"

  - path: "src/serena/resources/config/contexts/desktop-app.yml"
    changes:
      - "Update description to 'Desktop application context (chat application...)'"
      - "Simplify and clarify prompt text to match upstream"
      - "Remove verbose editor-switching advice"
    lines_affected: 15
    fork_customizations: "None detected - safe to update"

  - path: "src/serena/resources/config/contexts/agent.yml"
    changes:
      - "Update description to 'Agent context where the system prompt...' (shorter)"
      - "Simplify prompt from multi-line to single line"
    lines_affected: 6
    fork_customizations: "None detected - safe to update"

  - path: "src/serena/resources/config/contexts/chatgpt.yml"
    changes:
      - "Fix capitalization: 'chatgpt' -> 'ChatGPT' in description"
      - "Update tool_description_overrides: replace_regex -> replace_content"
      - "Update find_symbol override: name_path -> name_path_pattern"
    lines_affected: 8
    fork_customizations: "None detected - safe to update"

  - path: "src/serena/resources/config/contexts/codex.yml"
    changes:
      - "Update description to 'Codex Non-symbolic editing tools...'"
      - "Simplify prompt text to match upstream"
      - "Change excluded tool from 'replace_regex' to 'replace_content'"
    lines_affected: 27
    fork_customizations: "None detected - safe to update"

  - path: "src/serena/resources/config/contexts/context.template.yml"
    changes:
      - "Add single_project field documentation (7 lines of YAML comments + field)"
    lines_affected: 8
    fork_customizations: "None detected - safe to update"

# Files to Archive
files_to_archive:
  - path: "src/serena/resources/config/contexts/ide-assistant.yml"
    reason: "Replaced by claude-code.yml in Story 2, deleted in upstream"
    archive_location: "src/serena/resources/config/contexts/archive/ide-assistant.yml"
    notes: "Keep for backwards compatibility reference, but not loaded by context_mode.py (deprecated redirect to claude-code)"

# Integration Points
integration:
  - file: "src/serena/config/context_mode.py"
    type: "enum"
    description: "Verify RegisteredContext enum doesn't need IDE entry (upstream check shows no IDE enum)"
    action: "No changes needed - RegisteredContext already has CLAUDE_CODE and IDE_ASSISTANT (deprecated)"

  - file: "test/serena/test_context_mode.py"
    type: "test"
    description: "Existing tests verify claude-code context loads correctly"
    action: "Tests should still pass after updates, may need new test for ide.yml loading"

# Patterns to Follow
patterns:
  - source: "upstream:src/serena/resources/config/contexts/ide.yml"
    pattern: "New context files follow same structure: description, prompt, excluded_tools, tool_description_overrides, single_project"

  - source: "src/serena/resources/config/contexts/claude-code.yml"
    pattern: "Context updates preserve structure, only update content within sections"

  - source: "Story 2 implementation"
    pattern: "Archiving pattern: move file to archive/ subdirectory, keep for reference"

# Test Requirements
test_requirements:
  unit:
    - "Load ide.yml context successfully and verify structure"
    - "Load claude-code.yml context and verify replace_content in excluded_tools"
    - "Load all updated context files without YAML parsing errors"
    - "Verify context.template.yml includes single_project field documentation"
    - "Verify ide-assistant.yml is archived (not in main contexts directory)"

  integration:
    - "SerenaAgentContext.from_name('ide') loads successfully"
    - "SerenaAgentContext.from_name('claude-code') excludes replace_content tool"
    - "All registered contexts parse correctly via list_registered_context_names()"
    - "Context files with single_project: true behave correctly when project provided"

  security:
    - "Verify no sensitive data in context YAML files"
    - "Ensure archived ide-assistant.yml is not accessible via from_name() (should redirect)"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-4.1"
    text: "List all context YAML changes between fork and upstream"
    implementation: "files_to_modify (all 6 files) + files_to_create (ide.yml) + files_to_archive (ide-assistant.yml)"
    tests: "unit[0-4], integration[2]"
    notes: "Discovery phase identified 8 context files with changes"

  - id: "AC-4.2"
    text: "GATE: If any context files have fork-specific customizations â†’ Present diff to HUMAN for approval"
    implementation: "claude-code.yml has replace_regex vs replace_content difference"
    tests: "N/A - human gate during implementation"
    notes: "HUMAN APPROVAL REQUIRED: claude-code.yml excludes replace_regex (fork) vs replace_content (upstream)"

  - id: "AC-4.3"
    text: "Add new ide.yml context file from upstream"
    implementation: "files_to_create[0]"
    tests: "unit[0], integration[0]"

  - id: "AC-4.4"
    text: "Update claude-code.yml with upstream prompt improvements"
    implementation: "files_to_modify[0]"
    tests: "unit[1], integration[1]"

  - id: "AC-4.5"
    text: "Update desktop-app.yml, agent.yml, chatgpt.yml, codex.yml from upstream"
    implementation: "files_to_modify[1-4]"
    tests: "unit[2], integration[2]"

  - id: "AC-4.6"
    text: "Update context.template.yml with single_project field documentation"
    implementation: "files_to_modify[5]"
    tests: "unit[3]"

  - id: "AC-4.7"
    text: "Archive ide-assistant.yml (replaced by claude-code.yml)"
    implementation: "files_to_archive[0]"
    tests: "unit[4], integration[3]"

# Human Gate Details
human_gate:
  trigger: "AC-4.2"
  issue: "replace_regex vs replace_content tool exclusion"
  details: |
    Fork customization detected in claude-code.yml:

    FORK (current):
      excluded_tools:
        - replace_regex

    UPSTREAM:
      excluded_tools:
        - replace_content

    This suggests a tool rename: replace_regex -> replace_content.

    RECOMMENDATION: Accept upstream change (replace_content is the correct tool name).

    VERIFICATION NEEDED:
    1. Check if replace_regex still exists in codebase
    2. Check if replace_content is the new tool name
    3. Verify chatgpt.yml and codex.yml also reference replace_content in tool_description_overrides

  decision_options:
    - "Accept upstream (replace_content) - recommended if tool was renamed"
    - "Keep fork (replace_regex) - only if upstream has error"
    - "Investigate tool rename history before deciding"

# Implementation Notes
implementation_notes:
  - "Create archive directory: src/serena/resources/config/contexts/archive/"
  - "Move ide-assistant.yml to archive before applying other changes"
  - "Apply changes in order: archive -> create -> modify"
  - "Use git diff to verify changes match upstream exactly (except approved customizations)"
  - "Test context loading after each file update to catch errors early"
  - "HUMAN GATE: Present replace_regex vs replace_content diff and await approval"
