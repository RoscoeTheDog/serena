# Plan: 3
# Generated by: discovery:3.d
# Timestamp: 2025-12-23T20:00:00Z

story_id: "3"
title: "Merge Upstream Config Module Changes"
created: "2025-12-23T20:00:00Z"
created_by: "discovery:3.d"

# Analysis Summary
analysis:
  summary: "Merge upstream changes to context_mode.py and serena_config.py while preserving fork's centralized path storage via SerenaPaths. Requires human-reviewed side-by-side diffs and pattern conflict resolution before merge execution."
  complexity: "high"
  estimated_files: 4
  estimated_tokens: 12000
  risk_factors:
    - "Upstream may introduce path resolution patterns conflicting with SerenaPaths centralization"
    - "Config module changes might affect parent class inheritance pattern (ToolInclusionDefinition)"
    - "context_mode.py line 149: single_project field removal must be reconciled with upstream version"
    - "context_mode.py lines 172-177: deprecation mapping (ide-assistant → claude-code) must be preserved"
    - "serena_config.py lines 221-236: get_project_root() centralized storage pattern CRITICAL to preserve"
    - "GATE pattern requires human approval of diffs before any merge"

# Files to Create
files_to_create:
  - path: ".claude/sprint/reports/config-module-diff-3.d.md"
    purpose: "Side-by-side diff report for context_mode.py (ours vs upstream) with conflict annotations"
    pattern_source: ".claude/sprint/reports/conflict-analysis.md"
    estimated_lines: 300

  - path: ".claude/sprint/reports/serena-config-diff-3.d.md"
    purpose: "Side-by-side diff report for serena_config.py (ours vs upstream) with path resolution pattern analysis"
    pattern_source: ".claude/sprint/reports/conflict-analysis.md"
    estimated_lines: 400

  - path: ".claude/sprint/plans/3-merge-strategy.md"
    purpose: "Human-approved merge strategy document with line-by-line decisions for both files"
    pattern_source: ".claude/sprint/reports/conflict-analysis.md"
    estimated_lines: 200

# Files to Modify
files_to_modify:
  - path: "src/serena/config/context_mode.py"
    changes:
      - "Apply upstream changes while preserving deprecation mapping (lines 172-177)"
      - "Reconcile single_project field handling (line 149) with upstream version"
      - "Preserve ToolInclusionDefinition parent class inheritance"
    lines_affected: 20-50

  - path: "src/serena/config/serena_config.py"
    changes:
      - "Apply upstream changes while preserving SerenaPaths.get_project_root() method"
      - "Preserve centralized storage pattern (rel_path_to_project_yml returns centralized path)"
      - "Reconcile any upstream path resolution changes with our centralized approach"
    lines_affected: 30-80

# Integration Points
integration:
  - file: ".claude/sprint/tools/upstream_diff_analyzer.py"
    type: "tool"
    description: "Use existing diff analyzer to generate side-by-side diffs for config files"

  - file: "src/serena/constants.py"
    type: "dependency"
    description: "Contains SERENA_MANAGED_DIR_IN_HOME and related constants used in centralized storage"

  - file: "src/serena/config/__init__.py"
    type: "import"
    description: "May need updates if config module structure changes affect exports"

  - file: "src/serena/project.py"
    type: "dependency"
    description: "Uses ProjectConfig and centralized storage pattern - must remain compatible"

# Patterns to Follow
patterns:
  - source: "src/serena/config/serena_config.py (lines 221-236)"
    pattern: "Centralized storage: rel_path_to_project_yml returns ~/.serena/projects/{id}/project.yml, NOT in-project path"

  - source: "src/serena/config/context_mode.py (lines 172-177)"
    pattern: "Deprecation mapping: from_name() method redirects 'ide-assistant' → 'claude-code' with warning log"

  - source: "src/serena/config/context_mode.py (line 149)"
    pattern: "Backwards compatibility: data.pop('single_project', None) removes obsolete field before dataclass instantiation"

  - source: ".claude/sprint/reports/conflict-analysis.md"
    pattern: "GATE pattern: generate diff report → HALT → present to human → get approval → execute merge"

# Test Requirements
test_requirements:
  unit:
    - "context_mode.py: deprecation mapping works (ide-assistant → claude-code)"
    - "context_mode.py: single_project field removal doesn't break from_yaml()"
    - "serena_config.py: rel_path_to_project_yml() returns centralized path"
    - "serena_config.py: get_project_root() method preserved and functional"
    - "ToolInclusionDefinition inheritance chain intact after merge"
    - "YAML loading backward compatibility maintained"

  integration:
    - "ProjectConfig.load() works with centralized storage after merge"
    - "SerenaConfig.from_config_file() loads projects correctly"
    - "Context loading: both claude-code and ide-assistant (deprecated) work"
    - "Mode loading: default modes load successfully"
    - "No circular import dependencies introduced by merge"
    - "All existing tests in test suite pass"

  security:
    - "Path traversal prevention in centralized storage paths"
    - "No exposure of user home directory in error messages"
    - "Config file permissions properly set on creation"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-3.d.1"
    text: "(P0) GATE: Generate side-by-side diff of context_mode.py (ours vs upstream) → Present to HUMAN before any merge"
    implementation: "files_to_create[0] - config-module-diff-3.d.md"
    tests: "test_requirements.integration[0] - GATE pattern compliance"

  - id: "AC-3.d.2"
    text: "(P0) GATE: Generate side-by-side diff of serena_config.py (ours vs upstream) → Present to HUMAN before any merge"
    implementation: "files_to_create[1] - serena-config-diff-3.d.md"
    tests: "test_requirements.integration[0] - GATE pattern compliance"

  - id: "AC-3.d.3"
    text: "(P0) GATE: Check if upstream introduces new path resolution patterns → If conflicts with SerenaPaths, HALT and present options"
    implementation: "files_to_create[2] - 3-merge-strategy.md (conflict analysis section)"
    tests: "test_requirements.unit[2,3] - centralized path pattern preserved"

# Implementation Notes
implementation_notes:
  - "Use git show upstream/main:src/serena/config/context_mode.py to get upstream version"
  - "Use git show upstream/main:src/serena/config/serena_config.py to get upstream version"
  - "Compare line-by-line using diff tool with context (diff -u or similar)"
  - "Annotate diffs with conflict markers: [FORK-PRESERVE], [UPSTREAM-SAFE], [NEEDS-RECONCILE]"
  - "Focus areas for serena_config.py: lines 44-66 (SerenaPaths), lines 221-236 (rel_path_to_project_yml)"
  - "Focus areas for context_mode.py: lines 149 (single_project), lines 172-177 (deprecation mapping)"
  - "CRITICAL: Do NOT execute merge in discovery phase - only generate diffs and strategy"
  - "Merge strategy document must have explicit approval section for human sign-off"

# Dependencies
dependencies:
  - "Story 1 completed - conflict analysis report available"
  - "Story 2 completed - ide-assistant → claude-code rename done (affects deprecation mapping preservation)"
  - "upstream/main accessible via git"
  - "Merge base identified: aa8c5c6ff6dc5f0bba45acb20be145d37e94b3dc"

# Conflict Analysis from Story 1
upstream_conflicts:
  context_mode.py:
    severity: "Medium"
    architectural_markers: 2
    fork_enhancements:
      - "Deprecation mapping (ide-assistant → claude-code)"
      - "single_project field removal for backward compatibility"
    upstream_changes: "Unknown until diff generated"

  serena_config.py:
    severity: "Medium"
    architectural_markers: 2
    fork_enhancements:
      - "SerenaPaths class for centralized directory management"
      - "rel_path_to_project_yml() returns centralized path (~/.serena/projects/)"
      - "get_project_root() helper method"
    upstream_changes: "Unknown until diff generated"

# Next Steps
next_steps:
  - "Implementation phase (3.i) will generate diff reports and merge strategy document"
  - "Testing phase (3.t) will verify merged code passes all tests"
  - "GATE checkpoint after diff generation: Human must approve merge strategy before 3.i proceeds"

# Risk Mitigation
risk_mitigation:
  - risk: "Upstream introduces alternate path resolution"
    mitigation: "Side-by-side diff will identify pattern conflicts, human decides reconciliation approach"
  - risk: "Config module structure changes break inheritance"
    mitigation: "Test ToolInclusionDefinition inheritance chain after merge"
  - risk: "Deprecation mapping lost in merge"
    mitigation: "Explicitly preserve lines 172-177 in context_mode.py, verify in tests"
  - risk: "Centralized storage pattern broken"
    mitigation: "Preserve SerenaPaths class and rel_path_to_project_yml logic, verify paths in integration tests"
