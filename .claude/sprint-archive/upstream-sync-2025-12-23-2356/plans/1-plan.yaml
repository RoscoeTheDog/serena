# Plan: 1
# Generated by: discovery:1.d
# Timestamp: 2025-12-23T19:30:00Z

story_id: "1"
title: "Analyze Upstream Conflicts with Fork Enhancements"
created: "2025-12-23T19:30:00Z"
created_by: "discovery:1.d"

# Analysis Summary
analysis:
  summary: "Perform comprehensive git diff analysis between upstream/main and current fork, identifying conflicts in modified files (config/, tools/, project.py) and architectural pattern mismatches with our parent inheritance and centralized storage enhancements."
  complexity: "medium"
  estimated_files: 3
  estimated_tokens: 8000
  risk_factors:
    - "Upstream may have refactored config module structure conflicting with our centralized storage pattern"
    - "Tools module may have incompatible changes with our parent inheritance implementation"
    - "project.py centralized storage pattern (lines 26-27) may conflict with upstream project structure changes"
    - "GATE pattern requires human decision-making, blocking automated merge"

# Files to Create
files_to_create:
  - path: ".claude/sprint/tools/upstream_diff_analyzer.py"
    purpose: "Analyze git diff between upstream/main and current branch, identifying file-level conflicts in target directories"
    pattern_source: "src/serena/util/git.py"
    estimated_lines: 150

  - path: ".claude/sprint/tools/architectural_conflict_detector.py"
    purpose: "Detect architectural pattern conflicts between upstream changes and fork enhancements (parent inheritance, centralized storage)"
    pattern_source: "src/serena/util/git.py"
    estimated_lines: 200

  - path: ".claude/sprint/reports/conflict-analysis.md"
    purpose: "Human-readable conflict report with file-by-file analysis and resolution recommendations"
    pattern_source: ".claude/sprint/stories/*.md"
    estimated_lines: 100

# Files to Modify
files_to_modify: []

# Integration Points
integration:
  - file: "src/serena/util/git.py"
    type: "import"
    description: "Use existing git status utilities (get_git_status) as reference for git operations"

  - file: "src/serena/util/shell.py"
    type: "import"
    description: "Use subprocess_check_output for git diff and merge-base operations"

  - file: "src/serena/config/"
    type: "analysis-target"
    description: "Primary conflict analysis directory - check all .py files for upstream changes"

  - file: "src/serena/tools/"
    type: "analysis-target"
    description: "Secondary conflict analysis directory - check all .py files for upstream changes"

  - file: "src/serena/project.py"
    type: "analysis-target"
    description: "Critical file - centralized storage pattern (lines 26-27) must be preserved"

# Patterns to Follow
patterns:
  - source: "src/serena/util/git.py"
    pattern: "Use subprocess_check_output for safe git command execution with error handling"

  - source: "src/serena/util/shell.py"
    pattern: "Shell command execution with proper error handling and output capture"

  - source: ".claude/sprint/stories/1-analyze-upstream-conflicts.md"
    pattern: "GATE pattern - halt and present to human when conflicts detected, require explicit approval before proceeding"

# Test Requirements
test_requirements:
  unit:
    - "upstream_diff_analyzer correctly identifies modified files between branches"
    - "architectural_conflict_detector identifies centralized storage pattern conflicts"
    - "architectural_conflict_detector identifies parent inheritance pattern conflicts"
    - "conflict report generation produces valid markdown with all sections"
    - "error handling for missing upstream remote"
    - "error handling for git command failures"

  integration:
    - "full conflict analysis workflow: fetch upstream -> analyze diff -> generate report"
    - "GATE pattern implementation: detect conflicts -> halt -> present to human"
    - "conflict resolution strategy document created with human-approved decisions"
    - "verify no automated merge attempts when conflicts present"

  security:
    - "git command injection prevention in diff analyzer"
    - "path traversal prevention in report generation"
    - "validate upstream remote URL before fetch operations"

# Acceptance Criteria Mapping
acceptance_criteria:
  - id: "AC-1.d.1"
    text: "(P0) GATE: Scan upstream diff for changes to files we've modified → If conflicts found, HALT and present conflict map to HUMAN"
    implementation: "files_to_create[0] - upstream_diff_analyzer.py"
    tests: "test_requirements.integration[1] - GATE pattern implementation"

  - id: "AC-1.d.2"
    text: "(P0) Generate file-by-file conflict report for src/serena/config/, src/serena/tools/, src/serena/project.py"
    implementation: "files_to_create[2] - conflict-analysis.md"
    tests: "test_requirements.unit[3] - conflict report generation"

  - id: "AC-1.d.3"
    text: "(P0) GATE: Identify any upstream architectural patterns that contradict our enhancements → Present to HUMAN with options before proceeding"
    implementation: "files_to_create[1] - architectural_conflict_detector.py"
    tests: "test_requirements.unit[1,2] - architectural conflict detection"

# Implementation Notes
implementation_notes:
  - "Use git merge-base to find common ancestor between fork and upstream/main"
  - "Compare file tree changes: git diff --name-status $(git merge-base HEAD upstream/main)..upstream/main"
  - "For each modified file in target directories, run git diff to show line-level changes"
  - "Search for pattern conflicts: grep for 'centralized storage' patterns in upstream changes"
  - "Search for parent inheritance conflicts in config module changes"
  - "CRITICAL: Do NOT attempt automated merge - this is discovery/analysis only"
  - "Output must be human-readable with clear conflict categorization and resolution options"

# Dependencies
dependencies:
  - "Git repository with upstream remote configured (verified: https://github.com/oraios/serena.git)"
  - "upstream/main branch accessible"
  - "Current branch is sprint/upstream-sync"

# Next Steps
next_steps:
  - "Implementation phase (1.i) will execute the analysis tools and generate reports"
  - "Testing phase (1.t) will verify conflict detection accuracy and GATE pattern compliance"
  - "Human review required after conflict report generated (GATE pattern)"
